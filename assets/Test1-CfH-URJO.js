import{r as p,z as K,c as $,a as r,b,o as v,e as c,f as n,C as y,g as k,K as q,L as G,D as L,h as H,V as J}from"./index-B2s5Q_ZT.js";import{S as Q}from"./Store-D2uVx4-I.js";const W={class:"audio-upload"},X={class:"audio-player"},Y={class:"audio-upload"},Z={class:"size"},x=["onClick"],ee=["onClick"],se={__name:"Test1",setup(ae){const i=p([]),g=p(!1),m=p(null),U=p([]),D=p(),B=p(),j=async()=>{D.value=new Date;try{const a=await navigator.mediaDevices.getUserMedia({audio:!0});m.value=new MediaRecorder(a),U.value=[],m.value.ondataavailable=e=>{e.data.size>0&&U.value.push(e.data)},m.value.start(),g.value=!0,m.value.onstop=()=>{const e=new Blob(U.value,{type:"audio/mp3"});e.value=e,g.value=!1,a.getTracks().forEach(o=>o.stop()),O(e)}}catch(a){console.error("获取音频流失败：",a)}};function F(a,e){const o=new Date(a),t=new Date(e),s=Math.abs(t.getTime()-o.getTime());return Math.floor(s/1e3)}const O=async a=>{B.value=new Date;const e={name:`record-${i.value.length+1}.mp3`,url:URL.createObjectURL(a),blob:a,duration:`${F(D.value,B.value)}s`,size:z(a.size),file:new File([a],`record-${i.value.length+1}.mp3`,{type:"audio/mp3"})};i.value.unshift(e)},T=()=>{m.value&&(m.value.stop(),g.value=!1)},z=a=>`${(a/1024).toFixed(2)} KB`,E=a=>isNaN(a)||a===1/0?"未知":`${Math.floor(a)}s`,I=async a=>{const e=URL.createObjectURL(a),o=new Audio(URL.createObjectURL(a));return await new Promise(t=>{o.addEventListener("loadedmetadata",()=>{const s=o.duration,_=E(s),f={name:a.name,size:z(a.size),duration:_,isPlaying:!1,url:e,file:a,actualDuration:s};i.value.push(f),t()})}),!1},l=K({}),C=a=>{const e=i.value[a];l[a]||(l[a]=new Audio(e.url));const o=l[a];e.isPlaying?o.pause():(Object.entries(l).forEach(([t,s])=>{t!=a&&!s.paused&&(s.pause(),i.value[t].isPlaying=!1)}),o.play()),e.isPlaying=!e.isPlaying,o.addEventListener("ended",()=>{e.isPlaying=!1})},V=a=>{l[a]&&(l[a].pause(),l[a].src="",delete l[a]),i.value.splice(a,1)},P=p("second"),w=p(null),A=async()=>{const a=i.value.map(t=>t.blob),e=new Blob(a,{type:"audio/wav"}),o=URL.createObjectURL(e);await M(o),URL.revokeObjectURL(o),Object.keys(l).forEach(t=>{l[t].pause(),l[t].src="",delete l[t]})},M=async a=>{console.log("发送文件路径到后端:",a);const e=new FormData;e.append("text","在信息爆炸的时代，"),e.append("text_lang","zh"),e.append("prompt_lang","zh"),e.append("streaming_mode","true"),e.append("ref_audio_path","D://雷军.mp3"),console.log("最终 FormData 内容:",Array.from(e.entries()));const o=new URLSearchParams;for(const[u,d]of e.entries())o.append(u,d);const t=`/api2/tts?${o.toString()}`,_=(await fetch(t,{method:"GET"})).body.getReader(),f=[],R=async()=>{const{done:u,value:d}=await _.read();if(u){console.log("音频流处理完毕");const h=new Blob(f,{type:"audio/wav"}),S=URL.createObjectURL(h);console.log("生成的音频 URL:",S),w.value.src=S,w.value.load(),w.value.play().catch(N=>{console.error("播放音频失败:",N)});return}f.push(...d),await R()};R()};return(a,e)=>{const o=b("el-upload"),t=b("el-tab-pane"),s=b("el-col"),_=b("el-icon"),f=b("el-row"),R=b("el-tabs");return v(),$(f,null,{default:r(()=>[c(s,{span:12},{default:r(()=>[n("div",null,[n("audio",{ref_key:"audioPlayer",ref:w,controls:""},null,512),e[5]||(e[5]=n("h3",null,"输入音频",-1)),c(R,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=u=>P.value=u),class:"demo-tabs"},{default:r(()=>[c(t,{label:"上传音频",name:"second"},{default:r(()=>[n("div",W,[c(o,{class:"upload-component",accept:"audio/*","before-upload":I,"show-file-list":!1,"file-list":i.value,"on-remove":a.handleRemove,limit:0},{default:r(()=>e[1]||(e[1]=[n("div",{class:"upload-button"},[n("div",{class:"insert"}),n("h5",null,"添加或删除您的音频文件")],-1)])),_:1},8,["file-list","on-remove"])])]),_:1}),c(t,{label:"录制音频",name:"first"},{default:r(()=>[n("div",X,[g.value?(v(),y("div",{key:1,onClick:T,class:"record"},e[3]||(e[3]=[n("div",{class:"noRecord"},null,-1),k(" 停止录制 ")]))):(v(),y("div",{key:0,onClick:j,class:"record"},e[2]||(e[2]=[n("div",{class:"inRecord"},null,-1),k(" 点击开始录制 ")]))),e[4]||(e[4]=n("div",{style:{"font-size":"small",color:"#6b7280","margin-left":"20px"}}," *您可以使用自己的文本或下面的建议文本录制您的声音。",-1)),c(Q)])]),_:1}),n("div",Y,[(v(!0),y(q,null,G(i.value,(u,d)=>(v(),$(f,{key:d,class:"files"},{default:r(()=>[c(s,{span:2,class:"logo"}),c(s,{span:13,class:"file"},{default:r(()=>[k(L(u.name)+" ",1),n("div",Z,L(u.size),1)]),_:2},1024),c(s,{span:4},{default:r(()=>[k(L(u.duration),1)]),_:2},1024),c(s,{span:4,class:"btns"},{default:r(()=>[u.isPlaying?(v(),y("div",{key:1,class:"on",onClick:h=>C(d)},null,8,ee)):(v(),y("div",{key:0,class:"close",onClick:h=>C(d)},null,8,x)),c(_,{onClick:h=>V(d),class:"delete-btn",size:"25"},{default:r(()=>[c(H(J))]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))])]),_:1},8,["modelValue"]),n("button",{class:"next-btn",onClick:A},"创建")])]),_:1})]),_:1})}}};export{se as default};
